Create role (LabRole)
----------------------------
1. Open IAM Console - IAM â†’ Roles â†’ LabRole
2. Add inline policy - Click Add permissions â†’ Create inline policy
3. Policy JSON (copy-paste exactly)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem",
        "dynamodb:GetItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Resource": [
        "arn:aws:dynamodb:us-east-1:263015886377:table/InsuranceSystem",
        "arn:aws:dynamodb:us-east-1:263015886377:table/InsuranceSystem/index/*"
      ]
    },
    {
      "Sid": "SNSAccess",
      "Effect": "Allow",
      "Action": [
        "sns:ListTopics",
        "sns:CreateTopic",
        "sns:ListSubscriptionsByTopic",
        "sns:Subscribe",
        "sns:Publish",
        "sns:DeleteTopic"
      ],
      "Resource": "*"
    }
  ]
}
4.Save policy - name it InsuranceSystemDynamoAccess


upload install.zip
unzip install.zip -d .
chmod +x install.sh
./install.sh



Create API Gateway
-----------------
in file InsuranceSystemAPI-openapi.json replace the lambda arn from 263015886377 to the new arn number.

1. API Gateway â†’ Create API
2. Choose REST API
3. Select Import
4. Upload InsuranceSystemAPI-openapi.json
5. Choose Ignore warnings
6. Create
7. Enable CORS
8. create prod stage


1. change cognito domain to Managed login - Recommended
1. fix api authorizer 
2. update the config.js file in website\
  api getaway invoke url: baseAPI
  cognitoDomain: cognitoDomain
  cognito clientId : clientId
upload config.js to s3 bucket

---------------------------------
https://insurance-claim-damage.auth.us-east-1.amazoncognito.com/
login?client_id=37b83i5qebnrtavk9pp5lii50e&response_type=
code&scope=email+openid+profile&redirect_uri=
https://insurance-claim-damage-pages-v3.s3.us-east-1.amazonaws.com/index.html





- go to bucket policy
- Click Edit
- replace Resource to bucket ARN (copy ARN button)

{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::insurance-claim-damage-pages/*"
        }
    ]
}

import api getaway

API_ID=???
echo "Set lambdas functions permission"
for FUNC in addClaim addPolicy deletePolicy getPolicy getPolicies updateClaimStatus updatePolicy getAdminDashboard getAdminDashboardDrilldown getAdminStatistics getTokenData addDamageAreas importInsuranceData resendTokenNotification
do
  aws lambda add-permission \
    --function-name $FUNC \
    --statement-id apigw-$FUNC \
    --action lambda:InvokeFunction \
    --principal apigateway.amazonaws.com \
    --source-arn arn:aws:execute-api:us-east-1:263015886377:$API_ID/*/*/*
done

echo "Enable CORS on ALL resources"
RESOURCES=$(aws apigateway get-resources \
  --rest-api-id $API_ID \
  --query "items[].id" \
  --output text)

for RESOURCE_ID in $RESOURCES; do
  echo "Enabling CORS for resource $RESOURCE_ID"

  aws apigateway put-method \
    --rest-api-id $API_ID \
    --resource-id $RESOURCE_ID \
    --http-method OPTIONS \
    --authorization-type NONE \
    --no-api-key-required \
    --region $REGION 2>/dev/null || true

  aws apigateway put-method-response \
    --rest-api-id $API_ID \
    --resource-id $RESOURCE_ID \
    --http-method OPTIONS \
    --status-code 200 \
    --response-parameters '{
      "method.response.header.Access-Control-Allow-Origin": true,
      "method.response.header.Access-Control-Allow-Methods": true,
      "method.response.header.Access-Control-Allow-Headers": true
    }' \
    --region $REGION 2>/dev/null || true

  aws apigateway put-integration \
    --rest-api-id $API_ID \
    --resource-id $RESOURCE_ID \
    --http-method OPTIONS \
    --type MOCK \
    --request-templates '{"application/json":"{\"statusCode\":200}"}' \
    --region $REGION

  aws apigateway put-integration-response \
    --rest-api-id $API_ID \
    --resource-id $RESOURCE_ID \
    --http-method OPTIONS \
    --status-code 200 \
    --response-parameters '{
      "method.response.header.Access-Control-Allow-Origin": "'\''*'\''",
      "method.response.header.Access-Control-Allow-Methods": "'\''GET,POST,PUT,DELETE,OPTIONS'\''",
      "method.response.header.Access-Control-Allow-Headers": "'\''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'\''"
    }' \
    --region $REGION
done





Create role (LabRole)
----------------------------
1. Open IAM Console - IAM â†’ Roles â†’ LabRole
2. Add inline policy - Click Add permissions â†’ Create inline policy
3. Policy JSON (copy-paste exactly)
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DynamoDBAccess",
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem",
        "dynamodb:GetItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:Query",
        "dynamodb:Scan"
      ],
      "Resource": [
        "arn:aws:dynamodb:us-east-1:263015886377:table/InsuranceSystem",
        "arn:aws:dynamodb:us-east-1:263015886377:table/InsuranceSystem/index/*"
      ]
    },
    {
      "Sid": "SNSAccess",
      "Effect": "Allow",
      "Action": [
        "sns:ListTopics",
        "sns:CreateTopic",
        "sns:ListSubscriptionsByTopic",
        "sns:Subscribe",
        "sns:Publish",
        "sns:DeleteTopic"
      ],
      "Resource": "*"
    }
  ]
}
4.Save policy - name it InsuranceSystemDynamoAccess



Create Cognito
-----------------
Select:  "Single-page application (SPA)"
Name your application: "InsuranceSystemUserPool"
Options for sign-in identifiers: Email
Required attributes for sign-up: Email, Nikename
Allowed callback URLs
https://insurance-claim-damage-pages.s3.us-east-1.amazonaws.com/index.html
Allowed sign-out URLs
https://insurance-claim-damage-pages.s3.us-east-1.amazonaws.com/index.html
Add groups: admin, agent
Add 2 users with password : insurance.system.agent@gmail.com, insurance.system.agent@gmail.com 1463Aa99$
set groups to users: insurance.system.agent@gmail.com, insurance.system.agent@gmail.com agent


1 - Variables (edit only if needed)
--------------------------------------
REGION=us-east-1
USER_POOL_NAME="InsuranceSystemUserPool"
APP_CLIENT_NAME="`InsuranceSystemSPAClient`"

CALLBACK_URLS="http://localhost:62786/index.html https://insurance-claim-damage-pages.s3.us-east-1.amazonaws.com/index.html"
LOGOUT_URLS="http://localhost:62786/index.html https://insurance-claim-damage-pages.s3.us-east-1.amazonaws.com/index.html"


ADMIN_EMAIL="insurance.system.agent@gmail.com"
AGENT_EMAIL="insurance.system.manager@gmail.com"
PASSWORD="1463Aa99$"

2- Create Cognito User Pool (Email sign-in, required attributes)
-------------------------------------------
USER_POOL_ID=$(aws cognito-idp create-user-pool \
  --region $REGION \
  --pool-name "$USER_POOL_NAME" \
  --username-attributes email \
  --auto-verified-attributes email \
  --schema \
      Name=email,AttributeDataType=String,Required=true \
      Name=nickname,AttributeDataType=String,Required=true \
  --policies '{
    "PasswordPolicy": {
      "MinimumLength": 8,
      "RequireUppercase": true,
      "RequireLowercase": true,
      "RequireNumbers": true,
      "RequireSymbols": true
    }
  }' \
  --query "UserPool.Id" \
  --output text)

echo "User Pool ID: $USER_POOL_ID"


3 - Create App Client (SPA / public client)
--------------------------------------------------
APP_CLIENT_ID=$(aws cognito-idp create-user-pool-client \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --client-name "$APP_CLIENT_NAME" \
  --explicit-auth-flows \
      ALLOW_USER_PASSWORD_AUTH \
      ALLOW_REFRESH_TOKEN_AUTH \
      ALLOW_USER_SRP_AUTH \
  --supported-identity-providers COGNITO \
  --callback-urls $CALLBACK_URLS \
  --logout-urls $LOGOUT_URLS \
  --allowed-o-auth-flows code \
  --allowed-o-auth-scopes email openid profile \
  --allowed-o-auth-flows-user-pool-client \
  --prevent-user-existence-errors ENABLED \
  --query "UserPoolClient.ClientId" \
  --output text)

echo "App Client ID: $APP_CLIENT_ID"

4 - Create User Pool Groups
--------------------------------------------------------
aws cognito-idp create-group \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --group-name admin

aws cognito-idp create-group \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --group-name agent

5 - Create Users (with email + nickname)
--------------------------------------------------------
aws cognito-idp admin-create-user \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $ADMIN_EMAIL \
  --user-attributes \
      Name=email,Value=$ADMIN_EMAIL \
      Name=email_verified,Value=true \
      Name=nickname,Value=eden \
  --message-action SUPPRESS

aws cognito-idp admin-create-user \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $AGENT_EMAIL \
  --user-attributes \
      Name=email,Value=$AGENT_EMAIL \
      Name=email_verified,Value=true \
      Name=nickname,Value=sahar \
  --message-action SUPPRESS

6 - Set Permanent Passwords
--------------------------------------------------------
aws cognito-idp admin-set-user-password \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $ADMIN_EMAIL \
  --password "$PASSWORD" \
  --permanent

aws cognito-idp admin-set-user-password \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $AGENT_EMAIL \
  --password "$PASSWORD" \
  --permanent

7 - Assign Users to Groups
-------------------------------------------------------
aws cognito-idp admin-add-user-to-group \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $ADMIN_EMAIL \
  --group-name admin

aws cognito-idp admin-add-user-to-group \
  --region $REGION \
  --user-pool-id $USER_POOL_ID \
  --username $AGENT_EMAIL \
  --group-name agent

Create API Gateway Authorizer
----------------------
Create Authorizer with 
name InsuranceSystemCognitoAuthorizer 
Token source : Authorization based on "InsuranceSystemUserPool"
echo "Create API Gateway Authorizer"
aws apigateway create-authorizer \
  --rest-api-id "zszz1htpvi" \
  --name $AUTHORIZER_NAME \
  --type COGNITO_USER_POOLS \
  --identity-source "method.request.header.Authorization" \
  --provider-arns arn:aws:cognito-idp:$REGION:$ACCOUNT_ID:userpool/$USER_POOL_ID \
  --region $REGION



Create API Gateway
-----------------
in file InsuranceSystemAPI-openapi.json replace the lambda arn from 263015886377 to the new arn number.

1. API Gateway â†’ Create API
2. Choose REST API
3. Select Import
4. Upload InsuranceSystemAPI-openapi.json
5. Choose Ignore warnings
6. Create
7. Enable CORS
8. create prod stage


Create Lambdas
---------------------------
1. upload all zip files from install directory with cloud-shell action button.

2. add layers

aws lambda publish-layer-version \
    --layer-name auth-layer \
    --zip-file fileb:///home/cloudshell-user/auth-layer.zip \
    --compatible-runtimes python3.14

aws lambda publish-layer-version \
    --layer-name response-layer \
    --zip-file fileb:///home/cloudshell-user/response-layer.zip \
    --compatible-runtimes python3.14

ACCOUNT_ID=263015886377 <REPLACE>
for FUNC in addClaim addPolicy deletePolicy getPolicy getPolicies updateClaimStatus updatePolicy getAdminDashboard getAdminDashboardDrilldown getAdminStatistics getTokenData addDamageAreas importInsuranceData resendTokenNotification
do
  echo "Creating $FUNC ..."
  aws lambda create-function \
    --function-name $FUNC \
    --runtime python3.14 \
    --role arn:aws:iam::"$ACCOUNT_ID":role/LabRole \
    --handler $FUNC.handler \
    --zip-file fileb:///home/cloudshell-user/$FUNC.zip

  echo "Adding layers to $FUNC ..."
  aws lambda update-function-configuration \
    --function-name $FUNC \
    --layers arn:aws:lambda:us-east-1:"$ACCOUNT_ID":layer:auth-layer:1 arn:aws:lambda:us-east-1:"$ACCOUNT_ID":layer:response-layer:1
done


Create Dynamo DB database
----------------------------
aws dynamodb create-table \
  --table-name InsuranceSystem \
  --billing-mode PAY_PER_REQUEST \
  --attribute-definitions \
    AttributeName=PK,AttributeType=S \
    AttributeName=SK,AttributeType=S \
    AttributeName=GSI1PK,AttributeType=S \
    AttributeName=GSI1SK,AttributeType=S \
    AttributeName=GSI2PK,AttributeType=S \
    AttributeName=GSI2SK,AttributeType=S \
  --key-schema \
    AttributeName=PK,KeyType=HASH \
    AttributeName=SK,KeyType=RANGE \
  --global-secondary-indexes '[
    {
      "IndexName": "GSI1_UserPolicies",
      "KeySchema": [
        { "AttributeName": "GSI1PK", "KeyType": "HASH" },
        { "AttributeName": "GSI1SK", "KeyType": "RANGE" }
      ],
      "Projection": { "ProjectionType": "ALL" }
    },
    {
      "IndexName": "GSI2_PolicyClaims",
      "KeySchema": [
        { "AttributeName": "GSI2PK", "KeyType": "HASH" },
        { "AttributeName": "GSI2SK", "KeyType": "RANGE" }
      ],
      "Projection": { "ProjectionType": "ALL" }
    }
  ]'

aws dynamodb update-time-to-live \
  --table-name InsuranceSystem \
  --time-to-live-specification "Enabled=true,AttributeName=expiresAt"

aws lambda invoke --function-name importInsuranceData --cli-binary-format raw-in-base64-out --payload file://policy.json response.json

 
Create S3 bucket
----------------------------
1. create the bucket with name "insurance-claim-damage-pages"
BUCKET_NAME=insurance-claim-damage-pages
aws s3api create-bucket \
  --bucket $BUCKET_NAME \
  --region us-east-1

2. upload website.zip and extract into S3
unzip website.zip -d website
3. Upload the extracted files recursively to S3
aws s3 sync website/ s3://$BUCKET_NAME/
4. Verify
aws s3 ls s3://$BUCKET_NAME/
5. Enable static website hosting
aws s3 website s3://$BUCKET_NAME/ \
  --index-document index.html \
  --error-document index.html
6. Public access  - set off the Block public access (bucket settings)
- Go to S3 Console â†’ Bucket â†’ Permissions â†’ Block Public Access
- Click Edit
- Uncheck all
- Save changes

- go to bucket policy
- Click Edit
- replace Resource to bucket ARN (copy ARN button)

{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::insurance-claim-damage-pages/*"
        }
    ]
}


7. get website URL
aws s3api get-bucket-website --bucket $BUCKET_NAME


Create API getaway production stage
------------------------------------
1. aws apigateway get-rest-apis
{
  "items": [
    {
      "id": "6xlj4us919",
      "name": "InsuranceSystemAPI",
      "description": "My API",
      "createdDate": "2025-12-31T06:00:00Z"
    }
  ]
}
the "id" â€” this is your API_ID.
aws apigateway create-deployment \
  --rest-api-id 6xlj4us919 \
  --stage-name prod \
  --description "Production stage"

- the invoke URL
https://6xlj4us919.execute-api.us-east-1.amazonaws.com/prod

replace the BASE_API in config.js file
replace the cognito app client configuration in the config.js file

// Configuration
const IS_LOCALHOST = location.hostname === "localhost" || location.hostname === "127.0.0.1"
const BASE_API = "https://6xlj4us919.execute-api.us-east-1.amazonaws.com/prod";

const config = {
  cognitoDomain: 'https://insurance-system-domain.auth.us-east-1.amazoncognito.com',
  clientId: '7vqd0pi862rgeu7cje49pahmtj',
  redirectUri: IS_LOCALHOST
    ? 'http://localhost:62786/index.html'
    : 'https://insurance-claim-damage-pages.s3.us-east-1.amazonaws.com/index.html',
  scope: 'email openid profile',
  responseType: 'code'
};

2. Deploy API

#!/bin/bash

# ----------------------------
# CONFIG
# ----------------------------
API_ID="6xlj4us919"
STAGE_NAME="prod"
REGION="us-east-1"

# ----------------------------
# Loop over all resources
# ----------------------------
RESOURCE_IDS=$(aws apigateway get-resources \
  --rest-api-id $API_ID \
  --region $REGION \
  --query "items[].id" \
  --output text)

for RESOURCE_ID in $RESOURCE_IDS; do
  # Get all HTTP methods for this resource
  METHODS=$(aws apigateway get-resource \
    --rest-api-id $API_ID \
    --resource-id $RESOURCE_ID \
    --region $REGION \
    --query "resourceMethods | keys(@)" \
    --output text)

  for HTTP_METHOD in $METHODS; do
    echo "âœ… Enabling CORS for $HTTP_METHOD on resource $RESOURCE_ID"

    # 1ï¸âƒ£ Add OPTIONS method if not exists
    aws apigateway put-method \
      --rest-api-id $API_ID \
      --resource-id $RESOURCE_ID \
      --http-method OPTIONS \
      --authorization-type "NONE" \
      --region $REGION \
      2>/dev/null || true

    # 2ï¸âƒ£ Add MOCK integration for OPTIONS
    aws apigateway put-integration \
      --rest-api-id $API_ID \
      --resource-id $RESOURCE_ID \
      --http-method OPTIONS \
      --type MOCK \
      --request-templates '{"application/json": "{\"statusCode\": 200}"}' \
      --region $REGION \
      2>/dev/null || true

    # 3ï¸âƒ£ Add CORS headers to OPTIONS response
    aws apigateway put-method-response \
      --rest-api-id $API_ID \
      --resource-id $RESOURCE_ID \
      --http-method OPTIONS \
      --status-code 200 \
      --response-parameters \
        method.response.header.Access-Control-Allow-Headers=true \
        method.response.header.Access-Control-Allow-Methods=true \
        method.response.header.Access-Control-Allow-Origin=true \
      --region $REGION \
      2>/dev/null || true

    aws apigateway put-integration-response \
      --rest-api-id $API_ID \
      --resource-id $RESOURCE_ID \
      --http-method OPTIONS \
      --status-code 200 \
      --response-parameters 'method.response.header.Access-Control-Allow-Headers'="'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'",'method.response.header.Access-Control-Allow-Methods'="'GET,POST,PUT,DELETE,OPTIONS'",'method.response.header.Access-Control-Allow-Origin'="'*'" \
      --region $REGION \
      2>/dev/null || true
  done
done

# ----------------------------
# Deploy API
# ----------------------------
echo "ðŸš€ Deploying API to stage $STAGE_NAME"
aws apigateway create-deployment \
  --rest-api-id $API_ID \
  --stage-name $STAGE_NAME \
  --region $REGION




https://insurance-claim-damage.auth.us-east-1.amazoncognito.com/login?client_id=37b83i5qebnrtavk9pp5lii50e&response_type=code&scope=email+openid+phone&redirect_uri=https%3A%2F%2Finsurance-claim-damage-pages-v3.s3.us-east-1.amazonaws.com%2Findex.html&state=pD-1Y1jGwgU4fP.TJNwZZkKmw_Bxf36b&code_challenge=acZYTcWhGMVj4LuTesUJJs6ebMLWACWM_2Qn2YWoVEQ&code_challenge_method=S256


aws lambda add-permission \
  --function-name getAdminDashboard \
  --statement-id apigateway-invoke-getAdminDashboard \
  --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn arn:aws:execute-api:.../*

  aws lambda add-permission \
    --function-name $FUNC \
    --statement-id apigw-$FUNC \
    --action lambda:InvokeFunction \
    --principal apigateway.amazonaws.com \
    --source-arn "arn:aws:execute-api:$REGION:$ACCOUNT_ID:$API_ID/*/*/*" \
    --region $REGION || echo "Permission already exists"



REGION="us-east-1"
USER_POOL_NAME="InsuranceSystemUserPool-v05"
APP_CLIENT_NAME="InsuranceSystemSPAClient-v05"
DOMAIN_PREFIX="insurance-claim-damage-v05"
CALLBACK_URLS="https://insurance-claim-damage-pages-v8.s3.us-east-1.amazonaws.com/index.html"
LOGOUT_URLS="https://insurance-claim-damage-pages-v8.s3.us-east-1.amazonaws.com/index.html"

USER_POOL_ID=$(aws cognito-idp create-user-pool \
  --region $REGION \
  --pool-name "$USER_POOL_NAME" \
  --username-attributes "email" \
  --auto-verified-attributes "email" \
  --deletion-protection "ACTIVE" \
  --user-pool-tier "ESSENTIALS" \
  --schema '{"Name":"email","Required":true}' '{"Name":"nickname","Required":true}' \
  --username-configuration '{"CaseSensitive":false}' \
  --admin-create-user-config '{"AllowAdminCreateUserOnly":false}' \
  --query "UserPool.Id" \
  --output text)

APP_CLIENT_ID=$(aws cognito-idp create-user-pool-client \
  --client-name "$APP_CLIENT_NAME" \
  --user-pool-id $USER_POOL_ID \
  --no-generate-secret \
  --explicit-auth-flows \
      'ALLOW_REFRESH_TOKEN_AUTH' \
      'ALLOW_USER_SRP_AUTH' \
      'ALLOW_USER_AUTH' \
  --auth-session-validity 3  \
  --refresh-token-validity 5  \
  --access-token-validity 60  \
  --id-token-validity 60  \
  --token-validity-units '{"RefreshToken":"days","AccessToken":"minutes","IdToken":"minutes"}'  \
  --prevent-user-existence-errors ENABLED \
  --allowed-o-auth-flows code \
  --allowed-o-auth-scopes 'openid' 'phone' 'email' \
  --allowed-o-auth-flows-user-pool-client \
  --supported-identity-providers 'COGNITO' \
  --callback-urls "$CALLBACK_URLS" \
  --logout-urls "$LOGOUT_URLS" \
  --query "UserPoolClient.ClientId" \
  --output text)


aws cognito-idp create-user-pool-domain \
    --domain $DOMAIN_PREFIX \
    --user-pool-id $USER_POOL_ID \
    --region $REGION \
    --managed-login-version 2



aws cognito-idp create-user-pool-client  \
  --client-name 'saharTest1'  \
  --user-pool-id 'us-east-1_iuWCLvrpp'  \
  --explicit-auth-flows  \
    'ALLOW_REFRESH_TOKEN_AUTH'  \
    'ALLOW_USER_SRP_AUTH'  \
    'ALLOW_USER_AUTH'  \
  --auth-session-validity '3'  \
  --refresh-token-validity '5'  \
  --access-token-validity '60'  \
  --id-token-validity '60'  \
  --token-validity-units '{"RefreshToken":"days","AccessToken":"minutes","IdToken":"minutes"}'  \
  --prevent-user-existence-errors 'ENABLED'  \
  --allowed-o-auth-flows 'code'  \
  --allowed-o-auth-scopes 'openid' 'phone' 'email'  \
  --supported-identity-providers 'COGNITO'  \
  --callback-urls 'https://d84l1y8p4kdic.cloudfront.net'  \

aws cognito-idp create-user-pool-domain 
  --user-pool-id 'us-east-1_iuWCLvrpp' 
  --domain 'us-east-1iuwclvrpp' 
  --managed-login-version '2' 
  

  Swagger
  -------------
  Export : Stage Prod -> Export 
  Open API 3
  JSON
  Export with API Gateway extensions
  
  Editor : https://editor.swagger.io/


  apigateway via shell - check this 
  --------------------
  #!/bin/bash
set -e

### ===== CONFIG =====
OLD_ACCOUNT_ID="263015886377"
REGION="us-east-1"
API_NAME="InsuranceSystemAPI"
COGNITO_USER_POOL_NAME="InsuranceSystemUserPool"
OPENAPI_FILE="InsuranceSystemAPI-openapi.json"

NEW_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

LAMBDA_FUNCTIONS=(
  addClaim addPolicy deletePolicy getPolicy getPolicies
  updateClaimStatus updatePolicy
  getAdminDashboard getAdminDashboardDrilldown
  getAdminStatistics getTokenData
  addDamageAreas importInsuranceData resendTokenNotification
)

echo "Using AWS Account: $NEW_ACCOUNT_ID"
echo "Region: $REGION"

### ===== STEP 3: Replace Lambda Account ID =====
echo "Replacing Lambda Account ID in OpenAPI file..."
sed -i "s/$OLD_ACCOUNT_ID/$NEW_ACCOUNT_ID/g" "$OPENAPI_FILE"

### ===== STEP 3: Import API Gateway =====
echo "Importing API Gateway..."
API_ID=$(aws apigateway import-rest-api --region us-east-1 --body file://$OPENAPI_FILE --query id --output text)
API_ID=$(aws apigateway import-rest-api \
  --region $REGION \
  --endpoint-configuration types=REGIONAL \
  --body file://$OPENAPI_FILE \
  --query id \
  --output text)

echo "Created API Gateway with ID: $API_ID"

### ===== STEP 4: Fix Cognito Authorizer =====
echo "Fixing Cognito Authorizer..."

USER_POOL_ID=$(aws cognito-idp list-user-pools \
  --max-results 20 \
  --query "UserPools[?Name=='$COGNITO_USER_POOL_NAME'].Id | [0]" \
  --output text)

if [[ "$USER_POOL_ID" == "None" || -z "$USER_POOL_ID" ]]; then
  echo "ERROR: Cognito User Pool not found"
  exit 1
fi

AUTHORZER_ID=$(aws apigateway get-authorizers \
  --rest-api-id $API_ID \
  --query "items[?name=='InsuranceSystemCognitoAuthorizer'].id | [0]" \
  --output text)

aws apigateway update-authorizer \
  --rest-api-id $API_ID \
  --authorizer-id $AUTHORZER_ID \
  --patch-operations \
    op=replace,path=/providerARNs,value="arn:aws:cognito-idp:$REGION:$NEW_ACCOUNT_ID:userpool/$USER_POOL_ID"

echo "Authorizer updated successfully"

### ===== STEP 5: Allow API Gateway to invoke Lambdas =====
echo "Granting API Gateway invoke permissions..."

for FUNC in "${LAMBDA_FUNCTIONS[@]}"; do
  aws lambda add-permission \
    --function-name $FUNC \
    --statement-id apigw-$API_ID-$FUNC \
    --action lambda:InvokeFunction \
    --principal apigateway.amazonaws.com \
    --source-arn arn:aws:execute-api:$REGION:$NEW_ACCOUNT_ID:$API_ID/*/*/* \
    2>/dev/null || echo "Permission already exists for $FUNC"
done

### ===== STEP 6: Deploy prod stage =====
echo "Deploying prod stage..."
aws apigateway create-deployment \
  --rest-api-id $API_ID \
  --stage-name prod

echo "=========================================="
echo "SUCCESS!"
echo "API ID: $API_ID"
echo "Invoke URL:"
echo "https://$API_ID.execute-api.$REGION.amazonaws.com/prod"
echo "=========================================="


API_NAME="InsuranceSystemAPI"
COGNITO_USER_POOL_NAME="InsuranceSystemUserPool"
AUTHORIZER_NAME="InsuranceSystemCognitoAuthorizer"               
OPENAPI_FILE="api-getaway.json"
LAMBDA_FUNCTIONS=(
  addClaim addPolicy deletePolicy getPolicy getPolicies
  updateClaimStatus updatePolicy
  getAdminDashboard getAdminDashboardDrilldown
  getAdminStatistics getTokenData
  addDamageAreas importInsuranceData resendTokenNotification
)



echo "Import API getaway file"

echo "Replacing Lambda Account ID in OpenAPI file..."
sed -i "s/ACCOUNT_ID/$ACCOUNT_ID/g" "$OPENAPI_FILE"

echo "Importing API Gateway..."
API_ID=$(aws apigateway import-rest-api \
  --region $REGION \
  --body file://$OPENAPI_FILE \
  --query id \
  --output text)

API_ID=$(aws apigateway import-rest-api \
  --region $REGION \
  --body fileb://$OPENAPI_FILE \
  --no-cli-pager \
  --no-fail-on-warnings \
  --query id \
  --output text)

echo "Created API Gateway with ID: $API_ID"


echo "Fixing Cognito Authorizer..."
USER_POOL_ID="us-east-1_jG89Rm5UQ"
AUTHORIZER_ID=$(aws apigateway get-authorizers \
  --rest-api-id $API_ID \
  --query "items[?name=='$AUTHORIZER_NAME'].id | [0]" \
  --output text)

aws apigateway update-authorizer \
  --rest-api-id $API_ID \
  --authorizer-id $AUTHORIZER_ID \
  --patch-operations \
    op=add,path=/providerARNs,value="arn:aws:cognito-idp:$REGION:$ACCOUNT_ID:userpool/$USER_POOL_ID"

echo "Authorizer updated successfully"

echo "Granting API Gateway invoke permissions..."
for FUNC in "${LAMBDA_FUNCTIONS[@]}"; do
  aws lambda add-permission \
    --function-name $FUNC \
    --statement-id apigw-$API_ID-$FUNC \
    --action lambda:InvokeFunction \
    --principal apigateway.amazonaws.com \
    --source-arn arn:aws:execute-api:$REGION:$ACCOUNT_ID:$API_ID/*/*/*
done

echo "Deploying prod stage..."
aws apigateway create-deployment \
  --rest-api-id $API_ID \
  --stage-name prod


aws lambda invoke \
  --function-name importInsuranceData \
  --cli-binary-format raw-in-base64-out \
  --payload fileb://policies-import.json \
  response.json
