import json
import boto3
from boto3.dynamodb.conditions import Key
from decimal import Decimal

dynamo = boto3.resource("dynamodb")
table = dynamo.Table("InsuranceSystem")


def decimal_default(obj):
    if isinstance(obj, Decimal):
        return int(obj) if obj % 1 == 0 else float(obj)
    raise TypeError


def handler(event, context):
    try:
        path_params = event.get("pathParameters") or {}
        policy_number = path_params.get("policyNumber")

        if not policy_number:
            return {
                "statusCode": 400,
                "body": json.dumps({"error": "policyNumber is required"}),
                "headers": {"Access-Control-Allow-Origin": "*"}
            }

        # Get full policy metadata
        policy_response = table.get_item(
            Key={
                "PK": f"POLICY#{policy_number}",
                "SK": "METADATA"
            }
        )

        if "Item" not in policy_response:
            return {
                "statusCode": 404,
                "body": json.dumps({"error": "Policy not found"}),
                "headers": {"Access-Control-Allow-Origin": "*"}
            }

        policy_item = policy_response["Item"]

        # Get all claims using GSI
        response = table.query(
            IndexName="GSI2_PolicyClaims",
            KeyConditionExpression=Key("GSI2PK").eq(policy_number)
        )


        claims = []
        for item in response.get("Items", []):
            claims.append({
                "claimNumber": item.get("claimNumber"),
                "claimDate": item.get("claimDate"),
                "description": item.get("description"),
                "status": item.get("status"),
                "approvedAction": item.get("approvedAction"),
                "assessmentValue": item.get("assessmentValue"),
                "approvedValue": item.get("approvedValue"),
                "damageAreas": item.get("damageAreas", []),
                "createdAt": item.get("createdAt"),
                "updatedAt": item.get("updatedAt")
            })

        # Return full policy + claims
        return {
            "statusCode": 200,
            "body": json.dumps({
                "policy": policy_item,
                "claimsCount": len(claims),
                "claims": claims
            }, default=decimal_default, ensure_ascii=False),
            "headers": {"Access-Control-Allow-Origin": "*"}
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)}),
            "headers": {"Access-Control-Allow-Origin": "*"}
        }
# request
# {
#     "queryStringParameters": {
#     "policyNumber": "POL987654"
#   }
# }